name: Update Version Tags

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'Source branch to create PR from'
        required: true
        default: 'main'
        type: string
      ppp_manager_tag:
        description: 'PPP Manager version tag (e.g., v1.5.0)'
        required: false
        type: string
      vlan_manager_tag:
        description: 'VLAN Manager version tag (e.g., v1.5.0)'
        required: false
        type: string
      wan_manager_tag:
        description: 'WAN Manager version tag (e.g., v2.11.0)'
        required: false
        type: string
      gpon_manager_tag:
        description: 'GPON Manager version tag (e.g., v1.5.0)'
        required: false
        type: string
      xdsl_manager_tag:
        description: 'xDSL Manager version tag (e.g., v1.5.0)'
        required: false
        type: string
      ipoe_health_check_tag:
        description: 'IPoE Health Check version tag (e.g., v1.3.0)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  update-tags:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.source_branch }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Validate inputs
        run: |
          echo "Validating workflow inputs..."
          
          # Function to validate tag format
          validate_tag() {
            local tag=$1
            local component=$2
            
            if [ -n "$tag" ]; then
              if [[ ! "$tag" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                echo "‚ùå Invalid tag format for $component: $tag (expected format: vX.Y.Z)"
                exit 1
              else
                echo "‚úÖ Valid tag format for $component: $tag"
              fi
            fi
          }
          
          # Validate all provided tags
          validate_tag "${{ inputs.ppp_manager_tag }}" "PPP Manager"
          validate_tag "${{ inputs.vlan_manager_tag }}" "VLAN Manager"
          validate_tag "${{ inputs.wan_manager_tag }}" "WAN Manager"
          validate_tag "${{ inputs.gpon_manager_tag }}" "GPON Manager"
          validate_tag "${{ inputs.xdsl_manager_tag }}" "xDSL Manager"
          validate_tag "${{ inputs.ipoe_health_check_tag }}" "IPoE Health Check"
          
          # Check if at least one tag is provided
          if [ -z "${{ inputs.ppp_manager_tag }}${{ inputs.vlan_manager_tag }}${{ inputs.wan_manager_tag }}${{ inputs.gpon_manager_tag }}${{ inputs.xdsl_manager_tag }}${{ inputs.ipoe_health_check_tag }}" ]; then
            echo "‚ùå No version tags provided. Please specify at least one component to update."
            exit 1
          fi
          
          echo "‚úÖ All inputs validated successfully"

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create update branch
        id: branch
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="update-tags-$TIMESTAMP"
          git checkout -b "$BRANCH_NAME"
          echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Setup scripts
        run: |
          # Make Python script executable
          chmod +x .github/scripts/update_component.py
          
          # Verify Python is available and test the script
          python3 --version
          python3 .github/scripts/update_component.py --help > /dev/null

      - name: Capture Previous Versions
        id: capture-versions
        run: |
          # Capture previous values before any updates
          echo "üìã Capturing current versions before updates..."
          
          # Function to get current tag from BB file
          get_current_tag() {
            local bb_file=$1
            if [ -f "$bb_file" ]; then
              # Look for active GIT_TAG first, then commented ones
              grep "^GIT_TAG\s*=" "$bb_file" 2>/dev/null | sed 's/.*"\(.*\)".*/\1/' | head -1 || \
              grep "^#GIT_TAG\s*=" "$bb_file" 2>/dev/null | sed 's/.*"\(.*\)".*/\1/' | head -1
            fi
          }
          
          # Capture and store previous versions
          [ -n "${{ inputs.ppp_manager_tag }}" ] && echo "PREV_PPP_MANAGER=$(get_current_tag "recipes-ccsp/ccsp/rdk-ppp-manager.bb")" >> $GITHUB_ENV
          [ -n "${{ inputs.vlan_manager_tag }}" ] && echo "PREV_VLAN_MANAGER=$(get_current_tag "recipes-ccsp/ccsp/rdk-vlanmanager.bb")" >> $GITHUB_ENV  
          [ -n "${{ inputs.wan_manager_tag }}" ] && echo "PREV_WAN_MANAGER=$(get_current_tag "recipes-ccsp/ccsp/rdk-wanmanager.bb")" >> $GITHUB_ENV
          [ -n "${{ inputs.gpon_manager_tag }}" ] && echo "PREV_GPON_MANAGER=$(get_current_tag "recipes-ccsp/ccsp/rdkgponmanager.bb")" >> $GITHUB_ENV
          [ -n "${{ inputs.xdsl_manager_tag }}" ] && echo "PREV_XDSL_MANAGER=$(get_current_tag "recipes-ccsp/ccsp/rdkxdslmanager.bb")" >> $GITHUB_ENV
          [ -n "${{ inputs.ipoe_health_check_tag }}" ] && echo "PREV_IPOE_HC=$(get_current_tag "recipes-support/ipoe-health-check/ipoe-health-check.bb")" >> $GITHUB_ENV
          
          # Show captured versions for debugging
          echo "Captured previous versions:"
          [ -n "${{ inputs.ppp_manager_tag }}" ] && echo "PPP Manager: $(get_current_tag "recipes-ccsp/ccsp/rdk-ppp-manager.bb")"
          [ -n "${{ inputs.vlan_manager_tag }}" ] && echo "VLAN Manager: $(get_current_tag "recipes-ccsp/ccsp/rdk-vlanmanager.bb")"
          [ -n "${{ inputs.wan_manager_tag }}" ] && echo "WAN Manager: $(get_current_tag "recipes-ccsp/ccsp/rdk-wanmanager.bb")"
          [ -n "${{ inputs.gpon_manager_tag }}" ] && echo "GPON Manager: $(get_current_tag "recipes-ccsp/ccsp/rdkgponmanager.bb")"
          [ -n "${{ inputs.xdsl_manager_tag }}" ] && echo "xDSL Manager: $(get_current_tag "recipes-ccsp/ccsp/rdkxdslmanager.bb")"
          [ -n "${{ inputs.ipoe_health_check_tag }}" ] && echo "IPoE Health Check: $(get_current_tag "recipes-support/ipoe-health-check/ipoe-health-check.bb")"

      - name: Update Components
        run: |
          # Create a list of components to update
          COMPONENTS_TO_UPDATE=""
          
          if [ -n "${{ inputs.ppp_manager_tag }}" ]; then
            echo "üîÑ Updating PPP Manager with tag ${{ inputs.ppp_manager_tag }}"
            python3 .github/scripts/update_component.py \
              "${{ inputs.ppp_manager_tag }}" \
              "ppp-manager" \
              "recipes-ccsp/ccsp/rdk-ppp-manager.bb"
            COMPONENTS_TO_UPDATE="$COMPONENTS_TO_UPDATE PPP-Manager:${{ inputs.ppp_manager_tag }}"
          fi
          
          if [ -n "${{ inputs.vlan_manager_tag }}" ]; then
            echo "üîÑ Updating VLAN Manager with tag ${{ inputs.vlan_manager_tag }}"
            python3 .github/scripts/update_component.py \
              "${{ inputs.vlan_manager_tag }}" \
              "vlan-manager" \
              "recipes-ccsp/ccsp/rdk-vlanmanager.bb"
            COMPONENTS_TO_UPDATE="$COMPONENTS_TO_UPDATE VLAN-Manager:${{ inputs.vlan_manager_tag }}"
          fi
          
          if [ -n "${{ inputs.wan_manager_tag }}" ]; then
            echo "üîÑ Updating WAN Manager with tag ${{ inputs.wan_manager_tag }}"
            python3 .github/scripts/update_component.py \
              "${{ inputs.wan_manager_tag }}" \
              "wan-manager" \
              "recipes-ccsp/ccsp/rdk-wanmanager.bb"
            COMPONENTS_TO_UPDATE="$COMPONENTS_TO_UPDATE WAN-Manager:${{ inputs.wan_manager_tag }}"
          fi
          
          if [ -n "${{ inputs.gpon_manager_tag }}" ]; then
            echo "üîÑ Updating GPON Manager with tag ${{ inputs.gpon_manager_tag }}"
            python3 .github/scripts/update_component.py \
              "${{ inputs.gpon_manager_tag }}" \
              "gpon-manager" \
              "recipes-ccsp/ccsp/rdkgponmanager.bb"
            COMPONENTS_TO_UPDATE="$COMPONENTS_TO_UPDATE GPON-Manager:${{ inputs.gpon_manager_tag }}"
          fi
          
          if [ -n "${{ inputs.xdsl_manager_tag }}" ]; then
            echo "üîÑ Updating xDSL Manager with tag ${{ inputs.xdsl_manager_tag }}"
            python3 .github/scripts/update_component.py \
              "${{ inputs.xdsl_manager_tag }}" \
              "xdsl-manager" \
              "recipes-ccsp/ccsp/rdkxdslmanager.bb"
            COMPONENTS_TO_UPDATE="$COMPONENTS_TO_UPDATE xDSL-Manager:${{ inputs.xdsl_manager_tag }}"
          fi
          
          if [ -n "${{ inputs.ipoe_health_check_tag }}" ]; then
            echo "üîÑ Updating IPoE Health Check with tag ${{ inputs.ipoe_health_check_tag }}"
            python3 .github/scripts/update_component.py \
              "${{ inputs.ipoe_health_check_tag }}" \
              "ipoe-health-check" \
              "recipes-support/ipoe-health-check/ipoe-health-check.bb"
            COMPONENTS_TO_UPDATE="$COMPONENTS_TO_UPDATE IPoE-Health-Check:${{ inputs.ipoe_health_check_tag }}"
          fi
          
          # Save the list of updated components for later steps
          echo "UPDATED_COMPONENTS=$COMPONENTS_TO_UPDATE" >> $GITHUB_ENV
          
          if [ -z "$COMPONENTS_TO_UPDATE" ]; then
            echo "‚ùå No components to update. No tags were provided."
            exit 1
          else
            echo "‚úÖ Updated components:$COMPONENTS_TO_UPDATE"
          fi

      - name: Commit changes
        id: commit
        run: |
          # Check if there are any changes
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes detected. All specified tags may already be current."
            echo "has-changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Show what files will be changed
          echo "Files to be updated:"
          git diff --name-only
          
          # Create commit message with version diffs
          COMMIT_MSG="Update component version tags"
          
          if [ -n "${{ inputs.ppp_manager_tag }}" ]; then
            if [ -n "$PREV_PPP_MANAGER" ] && [ "$PREV_PPP_MANAGER" != "${{ inputs.ppp_manager_tag }}" ]; then
              COMMIT_MSG="$COMMIT_MSG\n\n- PPP Manager: $PREV_PPP_MANAGER ‚Üí ${{ inputs.ppp_manager_tag }}"
            else
              COMMIT_MSG="$COMMIT_MSG\n\n- PPP Manager: ${{ inputs.ppp_manager_tag }}"
            fi
          fi
          
          if [ -n "${{ inputs.vlan_manager_tag }}" ]; then
            if [ -n "$PREV_VLAN_MANAGER" ] && [ "$PREV_VLAN_MANAGER" != "${{ inputs.vlan_manager_tag }}" ]; then
              COMMIT_MSG="$COMMIT_MSG\n- VLAN Manager: $PREV_VLAN_MANAGER ‚Üí ${{ inputs.vlan_manager_tag }}"
            else
              COMMIT_MSG="$COMMIT_MSG\n- VLAN Manager: ${{ inputs.vlan_manager_tag }}"
            fi
          fi
          
          if [ -n "${{ inputs.wan_manager_tag }}" ]; then
            if [ -n "$PREV_WAN_MANAGER" ] && [ "$PREV_WAN_MANAGER" != "${{ inputs.wan_manager_tag }}" ]; then
              COMMIT_MSG="$COMMIT_MSG\n- WAN Manager: $PREV_WAN_MANAGER ‚Üí ${{ inputs.wan_manager_tag }}"
            else
              COMMIT_MSG="$COMMIT_MSG\n- WAN Manager: ${{ inputs.wan_manager_tag }}"
            fi
          fi
          
          if [ -n "${{ inputs.gpon_manager_tag }}" ]; then
            if [ -n "$PREV_GPON_MANAGER" ] && [ "$PREV_GPON_MANAGER" != "${{ inputs.gpon_manager_tag }}" ]; then
              COMMIT_MSG="$COMMIT_MSG\n- GPON Manager: $PREV_GPON_MANAGER ‚Üí ${{ inputs.gpon_manager_tag }}"
            else
              COMMIT_MSG="$COMMIT_MSG\n- GPON Manager: ${{ inputs.gpon_manager_tag }}"
            fi
          fi
          
          if [ -n "${{ inputs.xdsl_manager_tag }}" ]; then
            if [ -n "$PREV_XDSL_MANAGER" ] && [ "$PREV_XDSL_MANAGER" != "${{ inputs.xdsl_manager_tag }}" ]; then
              COMMIT_MSG="$COMMIT_MSG\n- xDSL Manager: $PREV_XDSL_MANAGER ‚Üí ${{ inputs.xdsl_manager_tag }}"
            else
              COMMIT_MSG="$COMMIT_MSG\n- xDSL Manager: ${{ inputs.xdsl_manager_tag }}"
            fi
          fi
          
          if [ -n "${{ inputs.ipoe_health_check_tag }}" ]; then
            if [ -n "$PREV_IPOE_HC" ] && [ "$PREV_IPOE_HC" != "${{ inputs.ipoe_health_check_tag }}" ]; then
              COMMIT_MSG="$COMMIT_MSG\n- IPoE Health Check: $PREV_IPOE_HC ‚Üí ${{ inputs.ipoe_health_check_tag }}"
            else
              COMMIT_MSG="$COMMIT_MSG\n- IPoE Health Check: ${{ inputs.ipoe_health_check_tag }}"
            fi
          fi
          
          git add .
          echo -e "$COMMIT_MSG" | git commit -F -
          echo "has-changes=true" >> $GITHUB_OUTPUT

      - name: Push branch
        if: steps.commit.outputs.has-changes == 'true'
        run: |
          git push origin ${{ steps.branch.outputs.branch-name }}

      - name: Create Pull Request
        if: steps.commit.outputs.has-changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prTitle = 'Update Component Version Tags';
            
            let prBody = '## üöÄ Component Version Updates\n\n';
            
            const inputs = context.payload.inputs;
            const prevVersions = {
              ppp_manager: process.env.PREV_PPP_MANAGER,
              vlan_manager: process.env.PREV_VLAN_MANAGER,
              wan_manager: process.env.PREV_WAN_MANAGER,
              gpon_manager: process.env.PREV_GPON_MANAGER,
              xdsl_manager: process.env.PREV_XDSL_MANAGER,
              ipoe_health_check: process.env.PREV_IPOE_HC
            };
            
            // Helper function to generate component changelog
            function generateComponentSection(componentName, newTag, prevTag, repoName) {
              if (!newTag) return '';
              
              let section = `### üì¶ ${componentName}\n\n`;
              
              if (prevTag && prevTag !== newTag) {
                section += `**Version Change:** \`${prevTag}\` ‚Üí \`${newTag}\`\n\n`;
                section += `**üîó Links:**\n`;
                section += `- [üìã Compare Changes](https://github.com/rdkcentral/${repoName}/compare/${prevTag}...${newTag})\n`;
                section += `- [üìù Release Notes](https://github.com/rdkcentral/${repoName}/releases/tag/${newTag})\n\n`;
                section += `**What changed:**\n`;
                section += `- Updated BitBake recipe from ${prevTag} to ${newTag}\n`;
                section += `- See [detailed comparison](https://github.com/rdkcentral/${repoName}/compare/${prevTag}...${newTag}) for code changes\n\n`;
              } else if (newTag) {
                section += `**New Version:** \`${newTag}\`${prevTag ? ' (no change)' : ' (initial setup)'}\n\n`;
                section += `**üîó Links:**\n`;
                section += `- [üìù Release Notes](https://github.com/rdkcentral/${repoName}/releases/tag/${newTag})\n\n`;
              }
              
              return section;
            }
            
            // Generate sections for each component
            prBody += generateComponentSection('PPP Manager', inputs.ppp_manager_tag, prevVersions.ppp_manager, 'ppp-manager');
            prBody += generateComponentSection('VLAN Manager', inputs.vlan_manager_tag, prevVersions.vlan_manager, 'vlan-manager');
            prBody += generateComponentSection('WAN Manager', inputs.wan_manager_tag, prevVersions.wan_manager, 'wan-manager');
            prBody += generateComponentSection('GPON Manager', inputs.gpon_manager_tag, prevVersions.gpon_manager, 'gpon-manager');
            prBody += generateComponentSection('xDSL Manager', inputs.xdsl_manager_tag, prevVersions.xdsl_manager, 'xdsl-manager');
            prBody += generateComponentSection('IPoE Health Check', inputs.ipoe_health_check_tag, prevVersions.ipoe_health_check, 'ipoe-health-check');
            
            prBody += '## üìã Summary of Changes\n\n';
            prBody += 'This PR updates BitBake recipe files (.bb) with new version tags and branch references.\n\n';
            prBody += '**Files Modified:**\n';
            
            if (inputs.ppp_manager_tag) prBody += '- `recipes-ccsp/ccsp/rdk-ppp-manager.bb`\n';
            if (inputs.vlan_manager_tag) prBody += '- `recipes-ccsp/ccsp/rdk-vlanmanager.bb`\n';
            if (inputs.wan_manager_tag) prBody += '- `recipes-ccsp/ccsp/rdk-wanmanager.bb`\n';
            if (inputs.gpon_manager_tag) prBody += '- `recipes-ccsp/ccsp/rdkgponmanager.bb`\n';
            if (inputs.xdsl_manager_tag) prBody += '- `recipes-ccsp/ccsp/rdkxdslmanager.bb`\n';
            if (inputs.ipoe_health_check_tag) prBody += '- `recipes-support/ipoe-health-check/ipoe-health-check.bb`\n';
            
            prBody += '\n## ‚úÖ Testing Checklist\n\n';
            prBody += 'Please verify that:\n';
            prBody += '- [ ] All updated tags exist in their respective repositories\n';
            prBody += '- [ ] The branch references are correct for each tag\n';
            prBody += '- [ ] The BitBake recipes build successfully\n';
            prBody += '- [ ] Component names are preserved correctly\n\n';
            prBody += '---\n';
            prBody += '*ü§ñ This PR was automatically generated by the Update Version Tags workflow.*';
            
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: prTitle,
              head: '${{ steps.branch.outputs.branch-name }}',
              base: '${{ inputs.source_branch }}',
              body: prBody,
              draft: false
            });
            
            console.log(`Created PR #${pr.number}: ${pr.html_url}`);

      - name: No changes summary
        if: steps.commit.outputs.has-changes == 'false'
        run: |
          echo "## Summary: No Changes Required"
          echo ""
          echo "All specified version tags are already current in the BitBake recipes."
          echo "No pull request was created."
          echo ""
          echo "### Specified Tags:"
          if [ -n "${{ inputs.ppp_manager_tag }}" ]; then
            echo "- PPP Manager: ${{ inputs.ppp_manager_tag }}"
          fi
          if [ -n "${{ inputs.vlan_manager_tag }}" ]; then
            echo "- VLAN Manager: ${{ inputs.vlan_manager_tag }}"
          fi
          if [ -n "${{ inputs.wan_manager_tag }}" ]; then
            echo "- WAN Manager: ${{ inputs.wan_manager_tag }}"
          fi
          if [ -n "${{ inputs.gpon_manager_tag }}" ]; then
            echo "- GPON Manager: ${{ inputs.gpon_manager_tag }}"
          fi
          if [ -n "${{ inputs.xdsl_manager_tag }}" ]; then
            echo "- xDSL Manager: ${{ inputs.xdsl_manager_tag }}"
          fi
          if [ -n "${{ inputs.ipoe_health_check_tag }}" ]; then
            echo "- IPoE Health Check: ${{ inputs.ipoe_health_check_tag }}"
          fi